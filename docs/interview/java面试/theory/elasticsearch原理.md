# Elasticsearch 简介

ElasticSearch 是当前流行的企业级搜索引擎，能够达到实时搜索，稳定，可靠，快速，安装使用方便，它提供了一个分布式多用户能力的全文搜索引擎。

# 搜索简介

举个简单的例子，比如要买手机，你登陆京东后，在搜索框搜索”手机“，会出现N个手机和手机周边的搜索数据

![img](https:////upload-images.jianshu.io/upload_images/16004177-bbe6d7d2ee2d440c.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)

## 常见搜索

百度、Google：我们想寻找一个我们喜欢的电影或者书籍就会去百度或者Google搜索一下。
 互联网搜索：电商搜索商品，招聘网站搜索简历或者岗位
 OA系统的搜索：员工管理搜索，会议管理搜索

## 数据库搜索

数据都是存储在数据库里面的，如电商网站的商品信息，如果从消费者去做搜索功能，我们会这么设计。

![img](https:////upload-images.jianshu.io/upload_images/16004177-0c91fe4c2ae50c5e.png?imageMogr2/auto-orient/strip|imageView2/2/w/1183/format/webp)

我们想要搜索手机，我们会这样写SQL

```csharp
select * from tb_product t where t.`name` ='手机%'
```

## 存在问题

第一、如果数据量在几万或者几十万时候，咱们可以快速查出，大家有没有想过，如果数据量在百万千万亿级别的时候，这样的查询还能满足我们的业务？
 从早上开始搜索，到晚上估计还没检索完毕，我估计客户会疯掉住院😔。

第二、不能将搜索词拆分开来，只能搜索名字是“手机”开头的手机商品，如果想搜出“华为手机”或者”手机壳“那是搜索不出来的。

第三、快速聚合，实时检索，咱们看京东搜索手机那个图，一输入手机，能实时检索出符合搜索内容有多少个商品。如果是数据库存储，实时与数据库交互，数据库早晚的崩的面目全非，估计的跑路了。

So 总体来说用数据库来实现搜索，不太靠谱，通常性能也会很差 。

## 倒排索引

倒排索引也叫反向索引，有反向索引必有正向索引。通俗来讲，正向索引是通过key找value，反向索引则是通过value找key。

倒排列表记录了出现过某个单词的所有文档的文档列表及单词在该文档中出现的位置信息，每条记录称为一个倒排项(Posting)。根据倒排列表，即可获知哪些文档包含某个单词。

比如我们百度大话西游，但是手抖动输入了”大话游“，看到返回的结果就是大话西游，结果确实是我想要找到的内容。

![img](https:////upload-images.jianshu.io/upload_images/16004177-ec4cf76fb5afab31.png?imageMogr2/auto-orient/strip|imageView2/2/w/950/format/webp)

包括大话西游游戏，大话西游电影，大话西游电视剧等各种信息，倒排索引就是将数据或者文档中的关键词拆分构建一个大表，每个文档会记录文档编号（DocID），单词在这个文档中出现的次数（TF）及单词在文档中哪些位置出现过等信息，这样与一个文档相关的信息被称做倒排索引项（Posting）。所以我们一搜索关键词，这些文档全部都会查询出来。

## 全文检索

当我们输入“大话游”,会被拆分成”大”，“话游”2个词，用2个词去倒排索引里面去检索数据，检索到的数据返回。整个过程就叫做全文检索

![img](https:////upload-images.jianshu.io/upload_images/16004177-d66c4cca8d496713.png?imageMogr2/auto-orient/strip|imageView2/2/w/971/format/webp)

image

如果用数据库的思维来做，假如一共1000W的记录，按照之前的思路就是扫描1000W次，每次扫描，都需要匹配那个文本所有的字符，确认是否包含搜索的关键词，而且还不能将搜索词拆解来进行检索 。

如果是利用倒排索引的话，假设还是1000W，拆分出来的词语，假设有1亿个词语，那么在倒排索引中，就有1亿行。我们可能不需要检索1亿次，有可能检索1次或者N+1，就能找到我们需要的数据，也有可能是100W次，也有可能是1000W次.

## Lucene

Lucene就是一个jar包库，里面包含了封装好的各种建立倒排索引，以及进行搜索的代码，包括各种算法，在我们就用java开发的时候会用到。

# Elasticsearch 功能

**第一、**分布式的搜索引擎和数据分析引擎

**搜索：**百度，网站的站内搜索，IT系统的检索
 **数据分析：**
 电商网站，最近一周手机商品销量排名前10的商家有哪些；
 新闻网站，最近1个月访问量排名前3的新闻版块是哪些

**第二、** 全文检索，结构化检索，数据分析

全文检索：我想搜索商品名称包含手机的商品，select * from products where product_name like "%手机%"
 结构化检索：我想搜索商品分类为电子数码的商品都有哪些，select * from products where category_id='电子数码'

部分匹配、自动完成、搜索纠错、搜索推荐
 数据分析：我们分析每一个商品分类下有多少个商品，select category_id,count(*) from products group by category_id

**第三、**对海量数据进行近实时的处理

分布式：ES自动可以将海量数据分散到多台服务器上去存储和检索
 海量数据的处理：分布式以后，就可以采用大量的服务器去存储和检索数据，自然而然就可以实现海量数据的处理了

近实时：检索个数据要花费1小时（这就不要近实时，离线批处理，batch-processing）；在秒级别对数据进行搜索和分析

跟分布式/海量数据相反的：lucene，单机应用，只能在单台服务器上使用，最多只能处理单台服务器可以处理的数据量

# Elasticsearch 适用场景

（1）维基百科和百度百科，手机维基百科，全文检索，高亮，搜索推荐。

（2）The Guardian（国外新闻网站），类似搜狐新闻，用户行为日志（点击，浏览，收藏，评论）+社交网络数据（对某某新闻的相关看法），数据分析，给到每篇新闻文章的作者，让他知道他的文章的公众反馈（好，坏，热门，垃圾，鄙视，崇拜）

（3）Stack Overflow（国外的程序异常讨论论坛），IT问题，程序的报错，提交上去，有人会跟你讨论和回答，全文检索，搜索相关问题和答案，程序报错了，就会将报错信息粘贴到里面去，搜索有没有对应的答案

（4）GitHub（开源代码管理），搜索上千亿行代码。

（5）电商网站，检索商品。

（6）日志数据分析，logstash采集日志，ES进行复杂的数据分析（ELK技术，elasticsearch+logstash+kibana）

（7）商品价格监控网站，用户设定某商品的价格阈值，当低于该阈值的时候，发送通知消息给用户，比如说订阅手机的监控，如果iphone的手机低于3000块钱，就通知我，我就去买

（8）BI系统，商业智能，Business Intelligence。比如说有个大型商场集团，BI，分析一下某某区域最近3年的用户消费金额的趋势以及用户群体的组成构成，产出相关的数张报表，**区，最近3年，每年消费金额呈现100%的增长，而且用户群体85%是高级白领，开一个新商场。ES执行数据分析和挖掘，Kibana进行数据可视化国内。

（9）国内：站内搜索（电商，招聘，门户，等等），IT OA系统搜索（OA，CRM，ERP，等等），数据分析（ES热门的一个使用场景）

# ElasticSearch 特点

（1）可以作为一个大型分布式集群（数百台服务器）技术，处理PB级数据，服务大公司；也可以运行在单机上，服务小公司

（2）Elasticsearch不是什么新技术，主要是将全文检索、数据分析以及分布式技术，合并在了一起，才形成了独一无二的ES；lucene（全文检索），商用的数据分析软件（也是有的），分布式数据库（mycat）

（3）对用户而言，是开箱即用的，非常简单，作为中小型的应用，直接3分钟部署一下ES，就可以作为生产环境的系统来使用了，数据量不大，操作不是太复杂

（4）数据库的功能面对很多领域是不够用的（事务，还有各种联机事务型的操作）；特殊的功能，比如全文检索，同义词处理，相关度排名，复杂数据分析，海量数据的近实时处理；Elasticsearch作为传统数据库的一个。

# ElasticSearch 原理

## 基本概念

Elasticsearch有几个核心的概念，花几分钟时间了解一下，有助于后面章节的学习。

### NRT

Near Realtime，近实时，有两个层面的含义，一是从写入一条数据到这条数据可以被搜索，有一段非常小的延迟（大约1秒左右），二是基于Elasticsearch的搜索和分析操作，耗时可以达到秒级。

### Cluster

集群，对外提供索引和搜索的服务，包含一个或多个节点，每个节点属于哪个集群是通过集群名称来决定的（默认名称是elasticsearch），集群名称搞错了后果很严重。命名建议是研发、测试环境、准生产、生产环境用不同的名称增加区分度，例如研发使用es-dev，测试使用es-test，准生产使用es-stg，生产环境使用es-pro这样的名字来区分。如果是中小型应用，集群可以只有一个节点。

![Elasticsearch集群结构](https://img2018.cnblogs.com/blog/1834889/201911/1834889-20191115073615083-212168071.png)

### Node

单独一个Elasticsearch服务器实例称为一个node，node是集群的一部分，每个node有独立的名称，默认是启动时获取一个UUID作为名称，也可以自行配置，node名称特别重要，Elasticsearch集群是通过node名称进行管理和通信的，一个node只能加入一个Elasticsearch集群当中，集群提供完整的数据存储，索引和搜索的功能，它下面的每个node分摊上述功能（每条数据都会索引到node上）。

### shard

分片，是单个Lucene索引，由于单台机器的存储容量是有限的（如1TB），而Elasticsearch索引的数据可能特别大（PB级别，并且30GB/天的写入量），单台机器无法存储全部数据，就需要将索引中的数据切分为多个shard，分布在多台服务器上存储。利用shard可以很好地进行横向扩展，存储更多数据，让搜索和分析等操作分布到多台服务器上去执行，提升集群整体的吞吐量和性能。
shard在使用时比较简单，只需要在创建索引时指定shard的数量即可，剩下的都交给Elasticsearch来完成，只是创建索引时一旦指定shard数量，后期就不能再更改了。

### replica

索引副本，完全拷贝shard的内容，shard与replica的关系可以是一对多，同一个shard可以有一个或多个replica，并且同一个shard下的replica数据完全一样，replica作为shard的数据拷贝，承担以下三个任务：

1. shard故障或宕机时，其中一个replica可以升级成shard。
2. replica保证数据不丢失（冗余机制），保证高可用。
3. replica可以分担搜索请求，提升整个集群的吞吐量和性能。

shard的全称叫primary shard，replica全称叫replica shard，primary shard数量在创建索引时指定，后期不能修改，replica shard后期可以修改。默认每个索引的primary shard值为5，replica shard值为1，含义是5个primary shard，5个replica shard，共10个shard。
因此Elasticsearch最小的高可用配置是2台服务器。

### Index

索引，具有相同结构的文档集合，类似于关系型数据库的数据库实例（6.0.0版本type废弃后，索引的概念下降到等同于数据库表的级别）。一个集群里可以定义多个索引，如客户信息索引、商品分类索引、商品索引、订单索引、评论索引等等，分别定义自己的数据结构。
索引命名要求全部使用小写，建立索引、搜索、更新、删除操作都需要用到索引名称。

### type

类型，原本是在索引(Index)内进行的逻辑细分，但后来发现企业研发为了增强可阅读性和可维护性，制订的规范约束，同一个索引下很少还会再使用type进行逻辑拆分（如同一个索引下既有订单数据，又有评论数据），因而在6.0.0版本之后，此定义废弃。

### Document

文档，Elasticsearch最小的数据存储单元，JSON数据格式，类似于关系型数据库的表记录（一行数据），结构定义多样化，同一个索引下的document，结构尽可能相同。

## 工作原理

简单地了解一下Elasticsearch的工作原理。

### 启动过程

当Elasticsearch的node启动时，默认使用广播寻找集群中的其他node，并与之建立连接，如果集群已经存在，其中一个节点角色特殊一些，叫coordinate node（协调者，也叫master节点），负责管理集群node的状态，有新的node加入时，会更新集群拓扑信息。如果当前集群不存在，那么启动的node就自己成为coordinate node。

![node加入集群过程](https://img2018.cnblogs.com/blog/1834889/201911/1834889-20191115073615238-1620969013.png)



### 应用程序与集群通信过程

虽然Elasticsearch设置了Coordinate Node用来管理集群，但这种设置对客户端（应用程序）来说是透明的，客户端可以请求任何一个它已知的node，如果该node是集群当前的Coordinate，那么它会将请求转发到相应的Node上进行处理，如果该node不是Coordinate，那么该node会先将请求转交给Coordinate Node，再由Coordinate进行转发，搓着各node返回的数据全部交由Coordinate Node进行汇总，最后返回给客户端。



![应用程序与Elasticsearch集群通信过程](https://img2018.cnblogs.com/blog/1834889/201911/1834889-20191115073615396-1105568420.png)



### 集群内node有效性检测

正常工作时，Coordinate Node会定期与拓扑结构中的Node进行通信，检测实例是否正常工作，如果在指定的时间周期内，Node无响应，那么集群会认为该Node已经宕机。集群会重新进行均衡：

1. 重新分配宕机的Node，其他Node中有该Node的replica shard，选出一个replica shard，升级成为primary shard。
2. 重新安置新的shard。
3. 拓扑更新，分发给该Node的请求重新映射到目前正常的Node上。